from kivy.app import App
from kivy.uix.floatlayout import FloatLayout
from kivy.uix.image import Image
from kivy.uix.spinner import Spinner, SpinnerOption
from kivy.uix.label import Label
from kivy.graphics import Color, RoundedRectangle
from arabic_reshaper import reshape as re
from bidi.algorithm import get_display as gd


def fa(text):
    return gd(re(text))


class PersianSpinnerOption(SpinnerOption):
    font_name = "Far_Nazanin"
    halign = "right"
    valign = "middle"


# ===================== داده‌ها (کامل کن) =====================
DATA = {
    "آذربایجان شرقی": {
        "تبریز": {
            "تفریحی": "ائل‌گلی",
            "مذهبی": "مسجد کبود",
            "تاریخی": "بازار تبریز"
        },
        "مراغه": {
            "تفریحی": "دره گشایش",
            "مذهبی": "امامزاده محمد",
            "تاریخی": "رصدخانه مراغه"
        }
    },

    "آذربایجان غربی": {
        "ارومیه": {
            "تفریحی": "دریاچه ارومیه",
            "مذهبی": "مسجد جامع",
            "تاریخی": "کلیسای ننه مریم"
        },
        "خوی": {
            "تفریحی": "پارک ملت",
            "مذهبی": "امامزاده سید بهلول",
            "تاریخی": "دروازه سنگی"
        }
    },

    "اردبیل": {
        "اردبیل": {
            "تفریحی": "دریاچه شورابیل",
            "مذهبی": "بقعه شیخ صفی",
            "تاریخی": "مجموعه شیخ صفی"
        },
        "مشگین‌شهر": {
            "تفریحی": "پل معلق",
            "مذهبی": "امامزاده سید سلیمان",
            "تاریخی": "قلعه قهقهه"
        }
    },

    "اصفهان": {
        "اصفهان": {
            "تفریحی": "پل خواجو",
            "مذهبی": "مسجد امام",
            "تاریخی": "نقش جهان"
        },
        "کاشان": {
            "تفریحی": "باغ فین",
            "مذهبی": "امامزاده حبیب بن موسی",
            "تاریخی": "خانه بروجردی‌ها"
        }
    },

    "البرز": {
        "کرج": {
            "تفریحی": "پارک چمران",
            "مذهبی": "امامزاده طاهر",
            "تاریخی": "کاخ مروارید"
        },
        "طالقان": {
            "تفریحی": "سد طالقان",
            "مذهبی": "امامزاده هارون",
            "تاریخی": "بافت قدیمی"
        }
    },

    "ایلام": {
        "ایلام": {
            "تفریحی": "جنگل ششدار",
            "مذهبی": "امامزاده علی صالح",
            "تاریخی": "قلعه والی"
        },
        "دهلران": {
            "تفریحی": "چشمه آب گرم",
            "مذهبی": "امامزاده سید ناصرالدین",
            "تاریخی": "آثار باستانی"
        }
    },

    "بوشهر": {
        "بوشهر": {
            "تفریحی": "ساحل خلیج فارس",
            "مذهبی": "امامزاده عبدالمهیمن",
            "تاریخی": "عمارت ملک"
        },
        "گناوه": {
            "تفریحی": "ساحل گناوه",
            "مذهبی": "امامزاده سلیمان",
            "تاریخی": "بافت قدیمی بندر"
        }
    },

    "تهران": {
        "تهران": {
            "تفریحی": "پارک آب و آتش",
            "مذهبی": "حرم شاه عبدالعظیم",
            "تاریخی": "کاخ گلستان"
        },
        "ری": {
            "تفریحی": "چشمه‌علی",
            "مذهبی": "حرم حضرت عبدالعظیم",
            "تاریخی": "برج طغرل"
        }
    },

    "چهارمحال و بختیاری": {
        "شهرکرد": {
            "تفریحی": "چشمه کوهرنگ",
            "مذهبی": "امامزاده حلیمه خاتون",
            "تاریخی": "قلعه چالشتر"
        },
        "لردگان": {
            "تفریحی": "آبشار آتشگاه",
            "مذهبی": "امامزاده سید عزیزالله",
            "تاریخی": "آثار تاریخی منطقه"
        }
    },

    "خراسان رضوی": {
        "مشهد": {
            "تفریحی": "طرقبه",
            "مذهبی": "حرم امام رضا",
            "تاریخی": "آرامگاه نادرشاه"
        },
        "نیشابور": {
            "تفریحی": "باغرود",
            "مذهبی": "قدمگاه",
            "تاریخی": "آرامگاه خیام"
        }
    },

    "خراسان جنوبی": {
        "بیرجند": {
            "تفریحی": "باغ اکبریه",
            "مذهبی": "امامزاده باقریه",
            "تاریخی": "ارگ کلاه‌فرنگی"
        },
        "قائن": {
            "تفریحی": "طبیعت قائن",
            "مذهبی": "امامزاده حسین",
            "تاریخی": "مسجد جامع"
        }
    },

    "خراسان شمالی": {
        "بجنورد": {
            "تفریحی": "پارک بش‌قارداش",
            "مذهبی": "امامزاده سلطان سیدعباس",
            "تاریخی": "عمارت مفخم"
        },
        "شیروان": {
            "تفریحی": "تفرجگاه زوارم",
            "مذهبی": "امامزاده حمزه رضا",
            "تاریخی": "قلعه جلال‌الدین"
        }
    },

    "خوزستان": {
        "اهواز": {
            "تفریحی": "ساحل کارون",
            "مذهبی": "علی بن مهزیار",
            "تاریخی": "پل سفید"
        },
        "شوش": {
            "تفریحی": "محوطه باستانی",
            "مذهبی": "حرم دانیال نبی",
            "تاریخی": "چغازنبیل"
        }
    },

    "زنجان": {
        "زنجان": {
            "تفریحی": "غار کتله‌خور",
            "مذهبی": "امامزاده سید ابراهیم",
            "تاریخی": "گنبد سلطانیه"
        },
        "ابهر": {
            "تفریحی": "طبیعت ابهر",
            "مذهبی": "امامزاده زید",
            "تاریخی": "مسجد جامع"
        }
    },

    "سمنان": {
        "سمنان": {
            "تفریحی": "جنگل ابر",
            "مذهبی": "امامزاده یحیی",
            "تاریخی": "دروازه ارگ"
        },
        "شاهرود": {
            "تفریحی": "جنگل ابر",
            "مذهبی": "امامزاده محمد",
            "تاریخی": "بافت تاریخی"
        }
    },

    "سیستان و بلوچستان": {
        "زاهدان": {
            "تفریحی": "کوه خواجه",
            "مذهبی": "مسجد جامع",
            "تاریخی": "شهر سوخته"
        },
        "چابهار": {
            "تفریحی": "ساحل مکران",
            "مذهبی": "مسجد جامع تیس",
            "تاریخی": "بندر تاریخی تیس"
        }
    },

    "فارس": {
        "شیراز": {
            "تفریحی": "باغ ارم",
            "مذهبی": "شاهچراغ",
            "تاریخی": "تخت جمشید"
        },
        "مرودشت": {
            "تفریحی": "طبیعت مرودشت",
            "مذهبی": "امامزاده اسماعیل",
            "تاریخی": "نقش رستم"
        }
    },

    "قزوین": {
        "قزوین": {
            "تفریحی": "پارک باراجین",
            "مذهبی": "امامزاده حسین",
            "تاریخی": "سردر عالی‌قاپو"
        },
        "تاکستان": {
            "تفریحی": "باغات انگور",
            "مذهبی": "امامزاده علی",
            "تاریخی": "آثار قدیمی"
        }
    },

    "قم": {
        "قم": {
            "تفریحی": "دریاچه حوض سلطان",
            "مذهبی": "حرم حضرت معصومه",
            "تاریخی": "مدرسه فیضیه"
        },
        "سلفچگان": {
            "تفریحی": "طبیعت اطراف",
            "مذهبی": "امامزاده هادی",
            "تاریخی": "بافت قدیمی"
        }
    },

    "کردستان": {
        "سنندج": {
            "تفریحی": "پارک آبیدر",
            "مذهبی": "مسجد جامع",
            "تاریخی": "عمارت آصف"
        },
        "مریوان": {
            "تفریحی": "دریاچه زریوار",
            "مذهبی": "مسجد جامع",
            "تاریخی": "آثار بومی"
        }
    },

    "کرمان": {
        "کرمان": {
            "تفریحی": "باغ شاهزاده",
            "مذهبی": "مسجد جامع",
            "تاریخی": "گنبد جبلیه"
        },
        "بم": {
            "تفریحی": "نخلستان‌ها",
            "مذهبی": "امامزاده زید",
            "تاریخی": "ارگ بم"
        }
    },

    "کرمانشاه": {
        "کرمانشاه": {
            "تفریحی": "طاق بستان",
            "مذهبی": "امامزاده ابراهیم",
            "تاریخی": "بیستون"
        },
        "پاوه": {
            "تفریحی": "طبیعت اورامانات",
            "مذهبی": "مسجد جامع",
            "تاریخی": "بافت پلکانی"
        }
    },

    "کهگیلویه و بویراحمد": {
        "یاسوج": {
            "تفریحی": "آبشار یاسوج",
            "مذهبی": "امامزاده مختار",
            "تاریخی": "آثار تاریخی"
        },
        "دهدشت": {
            "تفریحی": "طبیعت دهدشت",
            "مذهبی": "امامزاده بی‌بی حکیمه",
            "تاریخی": "بافت قدیمی"
        }
    },

    "گلستان": {
        "گرگان": {
            "تفریحی": "ناهارخوران",
            "مذهبی": "امامزاده نور",
            "تاریخی": "دیوار گرگان"
        },
        "گنبدکاووس": {
            "تفریحی": "پارک ملی",
            "مذهبی": "امامزاده یحیی",
            "تاریخی": "گنبد قابوس"
        }
    },

    "گیلان": {
        "رشت": {
            "تفریحی": "مرداب عینک",
            "مذهبی": "بقعه دانای علی",
            "تاریخی": "موزه میراث"
        },
        "لاهیجان": {
            "تفریحی": "شیطان‌کوه",
            "مذهبی": "امامزاده ابراهیم",
            "تاریخی": "بافت قدیمی"
        }
    },

    "لرستان": {
        "خرم‌آباد": {
            "تفریحی": "دریاچه کیو",
            "مذهبی": "امامزاده زید بن علی",
            "تاریخی": "قلعه فلک‌الافلاک"
        },
        "بروجرد": {
            "تفریحی": "پارک فدک",
            "مذهبی": "امامزاده جعفر",
            "تاریخی": "مسجد جامع"
        }
    },

    "مازندران": {
        "ساری": {
            "تفریحی": "پارک جنگلی",
            "مذهبی": "امامزاده عباس",
            "تاریخی": "خانه کلبادی"
        },
        "آمل": {
            "تفریحی": "جنگل الیمستان",
            "مذهبی": "امامزاده عبدالله",
            "تاریخی": "پل دوازده‌چشمه"
        }
    },

    "مرکزی": {
        "اراک": {
            "تفریحی": "پارک جنگلی",
            "مذهبی": "امامزاده محمدعابد",
            "تاریخی": "حمام چهار فصل"
        },
        "خمین": {
            "تفریحی": "طبیعت خمین",
            "مذهبی": "امامزاده اسماعیل",
            "تاریخی": "خانه امام خمینی"
        }
    },

    "هرمزگان": {
        "بندرعباس": {
            "تفریحی": "ساحل سورو",
            "مذهبی": "امامزاده سید مظفر",
            "تاریخی": "حمام گله‌داری"
        },
        "قشم": {
            "تفریحی": "دره ستارگان",
            "مذهبی": "مسجد جامع",
            "تاریخی": "قلعه پرتغالی‌ها"
        }
    },

    "همدان": {
        "همدان": {
            "تفریحی": "گنجنامه",
            "مذهبی": "امامزاده عبدالله",
            "تاریخی": "آرامگاه بوعلی"
        },
        "ملایر": {
            "تفریحی": "باغ سیفیه",
            "مذهبی": "امامزاده حسین",
            "تاریخی": "موزه لطفعلیان"
        }
    },

    "یزد": {
        "یزد": {
            "تفریحی": "بافت خشتی",
            "مذهبی": "امامزاده جعفر",
            "تاریخی": "میدان امیرچخماق"
        },
        "میبد": {
            "تفریحی": "کویر",
            "مذهبی": "امامزاده خدیجه خاتون",
            "تاریخی": "نارین قلعه"
        }
    }
}


class MainLayout(FloatLayout):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)

        # پس‌زمینه کاملاً سفید
        with self.canvas.before:
            Color(1, 1, 1, 1)
            self.bg = RoundedRectangle(pos=self.pos, size=self.size)
        self.bind(pos=self._update_bg, size=self._update_bg)

        # تصویر بالا (اختیاری)
        try:
            self.add_widget(Image(
                source="banner.jpg",  # اسم فایل عکس رو عوض کن یا این بخش رو کامنت کن
                size_hint=(1, 0.32),
                pos_hint={"top": 1},
                allow_stretch=True,
                keep_ratio=True
            ))
        except:
            pass  # بدون عکس هم اجرا می‌شه

        # توضیحات
        self.add_widget(Label(
            text=fa("لطفاً استان، شهر و نوع مکان را انتخاب کنید"),
            font_name="Far_Nazanin",
            font_size=22,
            color=(0.2, 0.2, 0.2, 1),
            size_hint=(0.92, 0.08),
            pos_hint={"center_x": 0.5, "top": 0.70},
            halign="center",
            valign="middle"
        ))

        # ۱. استان → سبز زنده
        self.provinces = list(DATA.keys())
        self.province_map = {fa(p): p for p in self.provinces}

        self.prov_spinner = Spinner(
            text=fa("انتخاب استان"),
            font_name="Far_Nazanin",
            values=list(self.province_map.keys()),
            option_cls=PersianSpinnerOption,
            size_hint=(0.78, 0.10),
            pos_hint={"center_x": 0.5, "top": 0.59},
            background_color=(0.13, 0.62, 0.25, 1)
        )
        self._style_button(self.prov_spinner, (0.1, 0.7, 0.1, 1))   # سبز پررنگ و زنده
        self.prov_spinner.bind(text=self.on_province)

        # ۲. شهر → سفید خالص (با کمی تمایز حاشیه‌ای)
        self.city_spinner = Spinner(
            text=fa("انتخاب شهر"),
            color=(0, 0, 0, 1),
            font_name="Far_Nazanin",
            option_cls=PersianSpinnerOption,
            size_hint=(0.78, 0.10),
            pos_hint={"center_x": 0.5, "top": 0.47},
            background_normal=""


        )
        self._style_button(self.city_spinner, (1.0, 1.0, 1.0, 1.0))  # سفید واقعی
        self.city_map = {}

        # ۳. نوع → قرمز زنده
        self.types = ["تاریخی", "مذهبی", "تفریحی"]
        self.type_map = {fa(t): t for t in self.types}

        self.type_spinner = Spinner(
            text=fa("انتخاب نوع"),
            font_name="Far_Nazanin",
            values=list(self.type_map.keys()),
            option_cls=PersianSpinnerOption,
            size_hint=(0.78, 0.10),
            pos_hint={"center_x": 0.5, "top": 0.35},
            background_color=(0.85, 0, 0, 1)
        )
        self._style_button(self.type_spinner, (0.9, 0.15, 0.15, 1.0))  # قرمز قوی
        self.type_spinner.bind(text=self.on_type)

        # نتیجه
        self.result = Label(
            text="",
            font_name="Far_Nazanin",
            font_size=30,
            color=(0, 0, 0, 1),
            size_hint=(0.92, 0.38),
            pos_hint={"center_x": 0.5, "y": 0.02},
            halign="center",
            valign="middle"
        )

        self.add_widget(self.prov_spinner)
        self.add_widget(self.city_spinner)
        self.add_widget(self.type_spinner)
        self.add_widget(self.result)

    def _update_bg(self, *args):
        self.bg.pos = self.pos
        self.bg.size = self.size

    def _style_button(self, widget, color):
        with widget.canvas.before:
            Color(*color)                      # رنگ اصلی دکمه
            widget.bg = RoundedRectangle(pos=widget.pos, size=widget.size, radius=[16])

            Color(0, 0, 0, 0.28)               # سایه مشکی نرم (طوسی نیست، فقط سایه)
            widget.shadow = RoundedRectangle(pos=(widget.x, widget.y - 10), size=widget.size, radius=[16])

        widget.bind(pos=self._update_styles, size=self._update_styles)

    def _update_styles(self, widget, *args):
        if hasattr(widget, 'bg'):
            widget.bg.pos = widget.pos
            widget.bg.size = widget.size
            widget.shadow.pos = (widget.x, widget.y - 10)
            widget.shadow.size = widget.size

    def on_province(self, spinner, value):
        prov = self.province_map.get(value)
        if prov:
            cities = list(DATA[prov].keys())
            self.city_map = {fa(c): c for c in cities}
            self.city_spinner.values = list(self.city_map.keys())
            self.city_spinner.text = fa("انتخاب شهر")
            self.result.text = ""
        else:
            self.city_spinner.values = []
            self.city_spinner.text = fa("ابتدا استان را انتخاب کنید")

    def on_type(self, spinner, value):
        prov_fa = self.prov_spinner.text
        city_fa = self.city_spinner.text

        prov = self.province_map.get(prov_fa)
        city = self.city_map.get(city_fa)
        typ = self.type_map.get(value)

        if prov and city and typ:
            place = DATA.get(prov, {}).get(city, {}).get(typ)
            self.result.text = fa(place) if place else fa("مکانی یافت نشد")
        else:
            self.result.text = fa("همه گزینه‌ها را انتخاب کنید")


class MyApp(App):
    def build(self):
        return MainLayout()


if __name__ == "__main__":
    MyApp().run()
